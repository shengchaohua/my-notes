

# 简介

分布式和集群类似。

从解决问题的角度，说一下分布式与集群的差异：

- 分布式是以缩短单个任务的执行时间来提升效率的；
- 集群则是通过提高单位时间内执行的任务数来提升效率。

从软件部署的角度，说一下分布式和集群的关系：

- 分布式是指将不同的业务分布在不同的地方；
- 集群则是将几台服务器集中在一起，实现同一业务；
- 分布式中的每一个节点，都可以做集群；
- 集群并不一定就是分布式的。


# 一致性哈希算法

一致性哈希算法（Consistent Hashing）主要用在分布式系统中。

一致性哈希算法是一种特殊的哈希算法。在使用一致哈希算法后，哈希表槽位数（大小）的改变平均只需要对 K/n 个关键字重新映射，其中K是关键字的数量，n是槽位数量。然而在传统的哈希表中，添加或删除一个槽位的几乎需要对所有关键字进行重新映射。

简单的说，一致性哈希是将整个哈希值空间组织成一个虚拟的圆环，如假设哈希函数H的值空间为0-2^32-1（哈希值是32位无符号整形），整个哈希空间环如下

![一致性哈希](https://raw.githubusercontent.com/shengchaohua/MyImages/main/images/20201101154017.png?token=AE4F4YMGN3FRWPEEHAWPHOC7TZTP4)

整个空间按顺时针方向组织，0和2^32-1在零点中方向重合。

接下来，把服务器按照IP或主机名作为关键字进行哈希，这样就能确定其在哈希环的位置。

在一致性Hash算法中，

- 如果一台服务器宕机，则受影响的数据仅仅是此服务器到其环空间中前一台服务器之间的数据，其他数据也不会受到影响。
- 如果增加一台服务器，则受影响的数据仅仅是新服务器到其环空间中前一台服务器之间数据，其它数据也不会受到影响。

综上所述，一致性Hash算法对于节点的增减都只需重定位环空间中的一小部分数据，具有较好的容错性和可扩展性。


# 负载均衡

随着业务量的提高，现有网络的各个核心部分访问量和数据流量的快速增长，其处理能力和计算强度也相应地增大，使得单一的服务器设备根本无法承担。

负载均衡（LB，Load Balance），是一种技术解决方案，用来在多个资源（一般是服务器）中分配负载，达到最优化资源使用，避免过载。

负载均衡（Load Balance）是分布式系统架构设计中必须考虑的因素之一。

负载均衡算法的种类有很多种，常见的负载均衡算法包括轮询法、随机法、源地址哈希法、加权轮询法、加权随机法、最小连接法等。

- 轮询（Round Robin）法：轮询很容易实现，将请求按顺序轮流分配到后台服务器上，均衡的对待每一台服务器，而不关心服务器实际的连接数和当前的系统负载。使用轮询策略的目的是，希望做到请求转移的绝对均衡，但付出的代价性能也是相当大的。为了保证pos变量的并发互斥，引入了重量级悲观锁synchronized，将会导致该轮询代码的并发吞吐量明显下降。轮询法适用于机器性能相同的服务，一旦某台机器性能不好，极有可能产生木桶效应，性能差的机器扛不住更多的流量。
- 随机法：通过系统随机函数，根据后台服务器列表的大小值来随机选取其中一台进行访问。由概率概率统计理论可以得知，随着调用量的增大，其实际效果越来越接近于平均分配流量到后台的每一台服务器，也就是轮询法的效果。同样地，它也不适用于机器性能有差异的分布式系统。
- 随机轮询法：所谓随机轮询，就是将随机法和轮询法结合起来，在轮询节点时，随机选择一个节点作为开始位置index，此后每次选择下一个节点来处理请求，即（index+1）%size。这种方式只是在选择第一个节点用了随机方法，其他与轮询法无异，缺点跟轮询一样。
- 源地址哈希法：源地址哈希法的思想是根据服务消费者请求客户端的IP地址，通过哈希函数计算得到一个哈希值，将此哈希值和服务器列表的大小进行取模运算，得到的结果便是要访问的服务器地址的序号。采用源地址哈希法进行负载均衡，相同的IP客户端，如果服务器列表不变，将映射到同一个后台服务器进行访问。该方法适合访问缓存系统，如果为了增强缓存的命中率和单调性，可以用一致性哈希算法。
- 加权轮询（Weight Round Robin）：不同的后台服务器可能机器的配置和当前系统的负载并不相同，因此它们的抗压能力也不一样。跟配置高、负载低的机器分配更高的权重，使其能处理更多的请求，而配置低、负载高的机器，则给其分配较低的权重，降低其系统负载，加权轮询很好的处理了这一问题，并将请求按照顺序且根据权重分配给后端。Nginx的负载均衡默认算法是加权轮询算法。



